<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: app.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: app.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

// app.js - cognicity-reports-powertrack modules

/* jshint node:true */
/* jshint unused:vars */ // We want to keep function parameters on callbacks like the originals
/* jshint curly:false */ // Don't require curly brackets around one-line statements

/**
 * @file Collect unconfirmed reports from Twitter &amp; send report verification tweets
 * @copyright (c) Tomas Holderness &amp; SMART Infrastructure Facility January 2014
 * @license Released under GNU GPLv3 License (see LICENSE.txt).
 * @example
 * Usage:	
 *     node daemon.js cognicity-reports-config.js start
 *     node daemon.js cognicity-reports-config.js status
 *     node daemon.js cognicity-reports-config.js stop
 */

// Modules
/** ntwitter twitter interface module */
var twitter = require('ntwitter');
/** Postgres interface module */
var pg = require('pg');
/** Winston logger module */
var logger = require('winston');
/** 
 * CognicityReportsPowertrack interface module
 * @type {CognicityReportsPowertrack}
 */
var cognicityReportsPowertrack = require('./CognicityReportsPowertrack.js');

// Verify expected arguments
if (process.argv[2]){
	var config = require(__dirname+'/'+process.argv[2]); 
} else {
	throw new Error('No config file. Usage: node app.js config.js');
}

// Logging configuration
logger
	// Configure custom File transport to write plain text messages
	.add(logger.transports.File, { 
		filename: __dirname+"/"+config.instance+".log", // Write to projectname.log
		json: false, // Write in plain text, not JSON
		maxsize: config.logger.maxFileSize, // Max size of each file
		maxFiles: config.logger.maxFiles, // Max number of files
		level: config.logger.level // Level of log messages
	})
	// Console transport is no use to us when running as a daemon
	.remove(logger.transports.Console);

logger.info("Application starting...");

// Verify DB connection is up
pg.connect(config.pg.conString, function(err, client, done){
	if (err){
		logger.error("DB Connection error: " + err);
		done();
		process.exit(1);
	}
});

// Configure new instance of the ntwitter interface
/** ntwitter interface instance */
var twit = new twitter({
	consumer_key: config.twitter.consumer_key,
	consumer_secret: config.twitter.consumer_secret,
	access_token_key: config.twitter.access_token_key,
	access_token_secret: config.twitter.access_token_secret
});

// Verify that the twitter connection was successful, fail if not
twit.verifyCredentials(function (err, data) {
	if (err) {
		logger.error("twit.verifyCredentials: Error verifying credentials: " + err);
		process.exit(1);
	} else {
		logger.info("twit.verifyCredentials: Twitter credentials succesfully verified");
	}
});

// Construct new instance of the cognicity module,
// passing in the configuration and pre-configured instances
// of other modules
var server = new cognicityReportsPowertrack(
	config,
	twit,
	pg,
	logger
);

// Catch unhandled exceptions, log, and exit with error status
process.on('uncaughtException', function (err) {
	logger.error('uncaughtException: ' + err.message + ", " + err.stack);
	process.exit(1);
});

// Catch kill and interrupt signals and log a clean exit status
process.on('SIGTERM', function() {
	logger.info('SIGTERM: Application shutting down');
	process.exit(0);
});
process.on('SIGINT', function() {
	logger.info('SIGINT: Application shutting down');
	process.exit(0);
});

// Start up the twitter feed - connect the Gnip stream
if ( config.gnip.stream ) server.connectStream();
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="CognicityReportsPowertrack.html">CognicityReportsPowertrack</a></li></ul><h3>Global</h3><ul><li><a href="global.html#cognicityReportsPowertrack">cognicityReportsPowertrack</a></li><li><a href="global.html#Gnip">Gnip</a></li><li><a href="global.html#logger">logger</a></li><li><a href="global.html#pg">pg</a></li><li><a href="global.html#twit">twit</a></li><li><a href="global.html#twitter">twitter</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha10</a> on Wed Nov 05 2014 16:24:08 GMT+1100 (EST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
